# 小遥搜索 XiaoyaoSearch - 技术选型文档

> **项目概述**：小遥搜索是一款支持多模态AI智能搜索的本地桌面应用，为知识工作者提供语音、文本、图像输入的智能文件检索能力。

## 1. 总体技术架构

### 架构模式
- **前后端分离架构**：Vue3前端 + FastAPI后端
- **桌面应用框架**：Electron提供跨平台支持
- **本地优先策略**：所有数据和AI处理均在本地完成
- **模块化设计**：搜索、索引、AI模型、配置管理等独立模块

### 技术栈全景图
```
┌─────────────────────────────────────────────────────────────────────┐
│                    Electron 桌面应用 (跨平台)                       │
├─────────────────────────────────────────────────────────────────────┤
│                     Vue 3 前端框架                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐        │
│  │ 搜索组件     │  │ 索引组件     │  │ 配置组件          │        │
│  │ Ant Design   │  │ 实时进度     │  │ AI模型管理        │        │
│  │ TypeScript   │  │ 状态管理     │  │ 应用设置          │        │
│  └──────────────┘  └──────────────┘  └──────────────────┘        │
├─────────────────────────────────────────────────────────────────────┤
│                   HTTP API 通信层                              │
│                 (Axios + FastAPI)                              │
├─────────────────────────────────────────────────────────────────────┤
│                         后端服务                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐        │
│  │ 搜索API      │  │ 索引API      │  │ 配置API            │        │
│  │ /api/search  │  │ /api/index   │  │ /api/config        │        │
│  └──────────────┘  └──────────────┘  └──────────────────┘        │
├─────────────────────────────────────────────────────────────────────┤
│                   AI模型层 (本地部署)                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐        │
│  │ BGE-M3       │  │ Ollama LLM   │  │ FasterWhisper     │        │
│  │ 文本嵌入      │  │ 查询增强      │  │ 语音识别           │        │
│  │ 1024维向量    │  │ qwen2.5:1.5b │  │ 本地处理           │        │
│  └──────────────┘  └──────────────┘  └──────────────────┘        │
├─────────────────────────────────────────────────────────────────────┤
│                   存储引擎                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐        │
│  │ Faiss        │  │ Whoosh      │  │ SQLite            │        │
│  │ 向量索引      │  │ 全文索引     │  │ 配置/元数据        │        │
│  │ IVF索引      │  │ 中文分词     │  │ 搜索历史          │        │
│  └──────────────┘  └──────────────┘  └──────────────────┘        │
└─────────────────────────────────────────────────────────────────────┘
```

## 2. 前端技术选型

### 2.1 核心框架
- **Electron 27+**
  - **选择原因**：提供跨平台桌面应用支持，Windows/macOS/Linux全平台兼容
  - **核心优势**：原生API访问、文件系统集成、本地存储能力
  - **替代方案对比**：
    - Tauri：更轻量但生态不够成熟
    - WebView2：Windows only，不符合跨平台需求

- **Vue 3 + Composition API**
  - **选择原因**：现代化响应式框架，TypeScript原生支持
  - **核心优势**：
    - 组合式API提供更好的代码组织
    - 性能优化（Virtual DOM重构）
    - 完善的TypeScript支持
  - **替代方案对比**：
    - React：生态丰富但学习曲线较陡
    - Angular：过于庞大，不适合轻量级桌面应用

### 2.2 UI组件库
- **Ant Design Vue 4.0+** ✅ 国际化支持已完成
  - **选择原因**：企业级UI组件库，完善的中文本地化
  - **核心优势**：
    - 丰富的组件体系（表格、表单、进度条等）
    - 一致的设计语言
    - 完善的国际化支持（Ant Design locale 集成）
    - 优秀的文档和社区支持
  - **国际化特性**：
    - 完整的 Ant Design locale 集成
    - 支持中英文语言包动态切换
    - 组件库内置文本完全国际化
  - **替代方案对比**：
    - Element Plus：组件不够丰富
    - Naive UI：生态相对较小

### 2.3 状态管理
- **Pinia**
  - **选择原因**：Vue 3官方推荐，简洁的API设计
  - **核心优势**：
    - TypeScript支持完善
    - 模块化状态管理
    - 开发工具友好
  - **使用场景**：搜索历史、用户设置、索引状态管理

### 2.4 网络通信
- **Axios**
  - **选择原因**：成熟的HTTP客户端，支持请求/响应拦截
  - **核心优势**：
    - Promise based API
    - 请求/响应拦截器
    - 自动JSON转换
    - 错误处理机制
  - **国际化特性** ✅：HTTP 错误信息前端翻译支持

### 2.5 国际化支持 ✅ 已完成
- **vue-i18n@9**
  - **选择原因**：Vue 3 官方国际化解决方案
  - **核心优势**：
    - Composition API 原生支持
    - 轻量级，体积小
    - 完善的 TypeScript 支持
    - 活跃的社区和文档
  - **技术规格**：
    - 720+ 翻译键，覆盖所有页面和组件
    - 支持中英文双语（zh-CN, en-US）
    - LocalStorage 语言偏好持久化
    - 工厂函数模式确保响应式翻译更新

- **Day.js**
  - **选择原因**：轻量级日期处理库，国际化支持完善
  - **核心优势**：
    - 体积小（仅 2KB）
    - 丰富的国际化插件
    - API 简洁易用
    - 与 vue-i18n 深度集成
  - **国际化特性**：
    - 相对时间格式（刚刚、5分钟前）
    - 绝对时间格式国际化
    - 多语言日期格式支持

## 3. 后端技术选型

### 3.1 Web框架
- **FastAPI 0.104+**
  - **选择原因**：现代化的Python Web框架，原生异步支持
  - **核心优势**：
    - 自动API文档生成（Swagger/OpenAPI）
    - Pydantic数据验证
    - 高性能异步处理
    - 类型提示支持
  - **替代方案对比**：
    - Django：过于重量级，不适合轻量级API
    - Flask：需要额外插件支持，开发效率较低

- **Uvicorn**
  - **选择原因**：ASGI服务器，与FastAPI完美集成
  - **核心优势**：高性能、支持WebSocket、热重载

### 3.2 数据库选择
- **SQLite**
  - **选择原因**：轻量级关系数据库，无需额外服务
  - **核心优势**：
    - 零配置，文件数据库
    - ACID事务支持
    - 跨平台兼容
    - Python内置支持
  - **使用场景**：
    - 文件索引元数据
    - 搜索历史记录
    - AI模型配置
    - 索引任务状态

### 3.3 ORM框架
- **SQLAlchemy 2.0+**
  - **选择原因**：Python最成熟的ORM框架
  - **核心优势**：
    - 强大的查询API
    - 数据库迁移支持（Alembic）
    - 连接池管理
    - 多数据库支持

## 4. AI模型技术选型

### 4.1 文本嵌入模型
- **BGE-M3 (BAAI/bge-m3)**
  - **选择原因**：中文优化的多语言embedding模型
  - **技术规格**：
    - 向量维度：1024维（从768维升级）
    - 上下文长度：8192 tokens
    - 支持语言：中英文等多语言
  - **核心优势**：
    - 中文语义理解能力强
    - 长文本处理能力
    - 开源免费，本地部署
  - **替代方案对比**：
    - OpenAI Embedding：需要API key，有使用成本
    - Sentence-BERT：中文支持较弱

### 4.2 大语言模型
- **Ollama + Qwen2.5:1.5b**
  - **选择原因**：本地部署的轻量级LLM，适合查询增强
  - **技术规格**：
    - 模型大小：1.5B参数（约1GB）
    - 硬件要求：低内存占用
    - 响应速度：本地推理快速
  - **核心优势**：
    - 完全本地运行，保护隐私
    - 低硬件要求
    - 支持中英文
  - **使用场景**：
    - 搜索查询增强和重写
    - 搜索结果摘要生成
    - 语音识别结果纠错

### 4.3 语音识别模型
- **FasterWhisper**
  - **选择原因**：本地化的语音识别，优化版本
  - **技术规格**：
    - 支持时长：30秒内音频
    - 响应时间：2-3秒
    - 支持格式：webm, wav, mp3
  - **核心优势**：
    - 本地处理，无需网络
    - 支持中文识别
    - GPU加速支持
  - **替代方案对比**：
    - 阿里云ASR：需要网络，有费用
    - Whisper原版：速度较慢

### 4.4 图像理解模型
- **Chinese-CLIP (OFA-Sys/chinese-clip-vit-base-patch16)**
  - **选择原因**：中文优化的图像-文本理解模型
  - **技术规格**：
    - 模型大小：ViT-Base
    - 图像尺寸：224x224
    - 支持格式：JPG, PNG
  - **核心优势**：
    - 中文图像理解能力强
    - 本地部署，保护隐私
    - 支持GPU加速

## 5. 搜索引擎技术选型

### 5.1 向量搜索引擎
- **Faiss (Facebook AI Similarity Search)**
  - **选择原因**：高效的向量相似度搜索库
  - **核心优势**：
    - 高性能向量检索
    - 支持多种索引类型（IVF, HNSW）
    - 内存效率高
    - 支持GPU加速
  - **索引策略**：
    - IVF（倒排文件索引）
    - 支持动态添加和删除
    - 支持批量搜索

### 5.2 全文搜索引擎
- **Whoosh**
  - **选择原因**：纯Python全文搜索库
  - **核心优势**：
    - 中文分词支持（jieba集成）
    - 丰富的查询语法
    - 轻量级，无外部依赖
    - 支持实时索引更新
  - **功能特性**：
    - 模糊搜索
    - 短语搜索
    - 字段权重
    - 高亮显示

### 5.3 混合搜索策略
- **结果融合算法**
  - **策略**：加权融合 + 重排序
  - **实现**：
    - 并行执行向量搜索和全文搜索
    - 结果去重和合并
    - 基于相关性重新排序
    - 支持动态权重调整

## 6. 文件处理技术选型

### 6.1 文档解析库
```python
# PDF处理
PyPDF2==3.0.1                    # PDF文本提取

# Office文档
python-docx==0.8.11              # Word文档(.docx)
docx2txt==0.9                    # Word文档(.doc/.docx)
openpyxl==3.1.2                  # Excel文档(.xlsx)
xlrd==2.0.2                      # Excel文档(.xls)
python-pptx==0.6.21              # PowerPoint文档

# 文本处理
chardet==5.0.0                   # 编码检测
```

### 6.2 音视频处理
```python
mutagen==1.46.0                  # 音频元数据提取
```

### 6.3 图像处理
```python
Pillow==10.1.0                   # 图像处理和格式转换
PaddleOCR==2.7.3                 # OCR文字识别
```

## 7. 部署和运维技术选型

### 7.1 打包分发
- **Electron Builder**
  - **选择原因**：成熟的Electron应用打包工具
  - **支持平台**：Windows, macOS, Linux
  - **核心功能**：
    - 自动更新机制
    - 代码签名
    - 安装包生成
    - 多平台构建

### 7.2 开发工具
- **代码质量**：
  - ESLint + Prettier（前端）
  - Black + isort + mypy（后端）
  - Husky（Git钩子）
- **测试框架**：
  - Vitest（前端单元测试）
  - Pytest（后端单元测试）
- **开发环境**：
  - Vite（前端构建工具）
  - Python虚拟环境
  - 热重载支持

## 8. 性能和安全考量

### 8.1 性能优化
- **AI模型优化**：
  - 模型量化（INT8）
  - 延迟加载
  - 内存管理
- **搜索优化**：
  - 索引分片
  - 并行处理
  - 结果缓存
- **前端优化**：
  - 虚拟滚动
  - 组件懒加载
  - 防抖节流

### 8.2 安全措施
- **数据安全**：
  - 本地数据存储
  - API密钥加密存储
  - 用户隐私保护
- **输入验证**：
  - 文件类型检查
  - 文件大小限制
  - SQL注入防护
- **错误处理**：
  - 全局异常捕获
  - 详细错误日志
  - 用户友好的错误提示

## 9. 技术选型对比表

| 技术领域 | 选择方案 | 替代方案 | 选择理由 |
|---------|---------|----------|----------|
| **前端框架** | Vue 3 | React, Angular | 学习曲线平缓，TypeScript支持完善 |
| **UI组件库** | Ant Design Vue | Element Plus, Naive UI | 组件丰富，中文本地化完善 |
| **后端框架** | FastAPI | Django, Flask | 高性能，自动API文档，异步支持 |
| **数据库** | SQLite | PostgreSQL, MySQL | 零配置，轻量级，适合本地应用 |
| **文本嵌入** | BGE-M3 | OpenAI Embedding | 本地部署，中文优化，零成本 |
| **语音识别** | FasterWhisper | 阿里云ASR | 本地处理，隐私保护，零延迟 |
| **图像理解** | Chinese-CLIP | OpenAI Vision | 中文支持，本地部署 |
| **大语言模型** | Ollama + Qwen2.5 | OpenAI GPT | 本地运行，隐私保护，低成本 |
| **向量搜索** | Faiss | Elasticsearch | 高性能，轻量级，支持GPU |
| **全文搜索** | Whoosh | Elasticsearch | 纯Python，中文支持，轻量级 |

## 10. 代码架构设计

### 10.1 项目目录结构
```
xiaoyaosearch/
├── frontend/                           # Electron + Vue3 前端
│   ├── src/
│   │   ├── main/                      # Electron 主进程
│   │   │   ├── services/              # 核心服务
│   │   │   │   ├── fileService.ts     # 文件系统操作
│   │   │   │   └── ipcService.ts      # 进程间通信
│   │   │   ├── utils/                 # 工具函数
│   │   │   │   ├── pathUtils.ts       # 路径处理
│   │   │   │   └── systemUtils.ts     # 系统工具
│   │   │   └── main.ts                # 主进程入口
│   │   ├── renderer/                  # 渲染进程 Vue3
│   │   │   ├── components/            # UI 组件
│   │   │   │   ├── common/            # 通用组件
│   │   │   │   │   ├── LoadingSpinner.vue
│   │   │   │   │   └── ProgressCard.vue
│   │   │   │   ├── search/            # 搜索相关组件
│   │   │   │   │   ├── SearchInput.vue
│   │   │   │   │   ├── SearchOptions.vue
│   │   │   │   │   └── SearchResults.vue
│   │   │   │   └── index/             # 索引相关组件
│   │   │   │       ├── IndexProgress.vue
│   │   │   │       ├── IndexList.vue
│   │   │   │       └── IndexCreate.vue
│   │   │   ├── views/                 # 页面视图
│   │   │   │   ├── Home.vue           # 主搜索页面
│   │   │   │   ├── Index.vue          # 索引管理页面
│   │   │   │   └── Settings.vue       # 设置页面
│   │   │   ├── api/                   # API 请求封装
│   │   │   │   ├── search.ts          # 搜索API
│   │   │   │   ├── index.ts           # 索引API
│   │   │   │   └── config.ts          # 配置API
│   │   │   ├── types/                 # TypeScript 类型定义
│   │   │   │   ├── api.ts             # API 响应类型
│   │   │   │   ├── search.ts          # 搜索相关类型
│   │   │   │   └── index.ts           # 索引相关类型
│   │   │   ├── utils/                 # 前端工具函数
│   │   │   │   ├── format.ts          # 格式化工具
│   │   │   │   └── validation.ts      # 验证工具
│   │   │   └── App.vue                # 根组件
│   │   ├── public/                    # 静态资源
│   │   │   └── icons/                 # 应用图标
│   │   ├── package.json
│   │   └── electron-builder.json      # 应用打包配置
├── backend/                           # Python FastAPI 后端
│   ├── app/
│   │   ├── api/                       # API 路由层
│   │   │   ├── search.py              # 搜索相关接口
│   │   │   │   ├── @router.post("/search")
│   │   │   │   ├── @router.post("/multimodal")
│   │   │   │   └── @router.get("/suggestions")
│   │   │   ├── index.py               # 索引管理接口
│   │   │   │   ├── @router.post("/create")
│   │   │   │   ├── @router.get("/status/{id}")
│   │   │   │   └── @router.delete("/{id}")
│   │   │   ├── config.py              # 配置管理接口
│   │   │   │   ├── @router.get("/models")
│   │   │   │   └── @router.post("/models")
│   │   │   └── system.py              # 系统相关接口
│   │   │       └── @router.get("/health")
│   │   ├── core/                      # 核心业务逻辑
│   │   │   ├── search/                # 搜索引擎
│   │   │   │   ├── __init__.py
│   │   │   │   ├── hybrid_search.py   # 混合搜索引擎
│   │   │   │   ├── semantic_search.py # 语义搜索
│   │   │   │   └── fulltext_search.py # 全文搜索
│   │   │   ├── indexing/              # 索引管理
│   │   │   │   ├── __init__.py
│   │   │   │   ├── file_indexer.py    # 文件索引器
│   │   │   │   ├── vector_indexer.py  # 向量索引器
│   │   │   │   └── text_indexer.py    # 文本索引器
│   │   │   ├── ai_models/             # AI 模型服务
│   │   │   │   ├── __init__.py
│   │   │   │   ├── embedding_service.py # 文本嵌入服务
│   │   │   │   ├── llm_service.py     # 大语言模型服务
│   │   │   │   ├── speech_service.py   # 语音识别服务
│   │   │   │   └── vision_service.py   # 图像理解服务
│   │   │   └── database/              # 数据库操作
│   │   │       ├── __init__.py
│   │   │       ├── connection.py      # 数据库连接
│   │   │       └── migrations/        # 数据库迁移
│   │   ├── models/                    # 数据模型
│   │   │   ├── __init__.py
│   │   │   ├── base.py                # 基础模型类
│   │   │   ├── file.py                # 文件模型
│   │   │   ├── index_job.py           # 索引任务模型
│   │   │   ├── search_history.py      # 搜索历史模型
│   │   │   └── ai_model.py            # AI模型配置
│   │   ├── schemas/                   # Pydantic 数据验证
│   │   │   ├── __init__.py
│   │   │   ├── search.py              # 搜索请求/响应
│   │   │   ├── index.py               # 索引请求/响应
│   │   │   └── config.py              # 配置请求/响应
│   │   ├── services/                  # 业务服务层
│   │   │   ├── __init__.py
│   │   │   ├── search_service.py      # 搜索业务逻辑
│   │   │   ├── index_service.py       # 索引业务逻辑
│   │   │   └── config_service.py      # 配置业务逻辑
│   │   ├── utils/                     # 工具函数
│   │   │   ├── __init__.py
│   │   │   ├── file_utils.py          # 文件处理工具
│   │   │   ├── text_utils.py          # 文本处理工具
│   │   │   └── logger.py              # 日志工具
│   │   └── main.py                    # FastAPI 应用入口
│   ├── tests/                         # 测试用例
│   │   ├── test_search.py             # 搜索功能测试
│   │   ├── test_index.py              # 索引功能测试
│   │   └── test_api.py                # API 接口测试
│   ├── requirements.txt               # Python 依赖
│   └── .env                           # 环境配置文件
├── data/                              # 应用数据目录
│   ├── database/                      # SQLite 数据库
│   │   └── xiaoyao_search.db
│   ├── indexes/                       # 搜索索引
│   │   ├── faiss/                     # Faiss 向量索引
│   │   │   ├── document_index.faiss
│   │   │   └── metadata.pkl
│   │   └── whoosh/                    # Whoosh 全文索引
│   │       ├── MAIN_0.seg
│   │       └── _toc.json
│   ├── models/                        # AI 模型文件
│   │   ├── bge-m3/                    # BGE-M3 模型缓存
│   │   └── faster-whisper/            # FasterWhisper 模型缓存
│   └── logs/                          # 应用日志
│       ├── app.log
│       └── error.log
└── docs/                              # 项目文档
    ├── 技术选型.md                    # 技术选型文档
    ├── 03-技术方案.md                 # 技术方案文档
    └── 开发进度.md                    # 开发进度文档
```

### 10.2 前端代码架构

#### 10.2.1 组件设计模式
```typescript
// composables/useSearch.ts - 搜索逻辑组合式函数
import { ref, computed } from 'vue'
import { SearchService } from '@/api/search'
import type { SearchRequest, SearchResult } from '@/types/api'

export function useSearch() {
  const searchQuery = ref('')
  const searchResults = ref<SearchResult[]>([])
  const isSearching = ref(false)

  const handleSearch = async (request: SearchRequest) => {
    isSearching.value = true
    try {
      const response = await SearchService.search(request)
      if (response.success) {
        searchResults.value = response.data.results
      }
    } finally {
      isSearching.value = false
    }
  }

  return {
    searchQuery,
    searchResults,
    isSearching,
    handleSearch
  }
}
```

#### 10.2.2 API 封装架构
```typescript
// api/search.ts - 搜索 API 封装
import axios from 'axios'
import type { SearchRequest, SearchResponse, MultimodalRequest } from '@/types/api'

const API_BASE_URL = 'http://127.0.0.1:8000/api'

class SearchService {
  private client = axios.create({
    baseURL: API_BASE_URL,
    timeout: 30000
  })

  async search(request: SearchRequest): Promise<SearchResponse> {
    const response = await this.client.post('/search', request)
    return response.data
  }

  async multimodalSearch(
    inputType: 'voice' | 'image',
    file: File,
    searchType: string,
    limit: number,
    threshold: number,
    fileTypes: string[]
  ): Promise<SearchResponse> {
    const formData = new FormData()
    formData.append('file', file)
    formData.append('input_type', inputType)
    formData.append('search_type', searchType)
    formData.append('limit', limit.toString())
    formData.append('threshold', threshold.toString())
    formData.append('file_types', JSON.stringify(fileTypes))

    const response = await this.client.post('/multimodal', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    })
    return response.data
  }
}

export const searchService = new SearchService()
```

#### 10.2.3 状态管理模式
```typescript
// stores/search.ts - Pinia 搜索状态管理
import { defineStore } from 'pinia'
import type { SearchHistory, SearchOptions } from '@/types/api'

export const useSearchStore = defineStore('search', {
  state: () => ({
    searchHistory: [] as SearchHistory[],
    searchOptions: {
      searchType: 'hybrid',
      threshold: 0.5,
      fileTypes: []
    } as SearchOptions,
    recentQueries: [] as string[]
  }),

  actions: {
    addToHistory(query: string, resultsCount: number) {
      const history: SearchHistory = {
        id: Date.now(),
        query,
        resultCount: resultsCount,
        timestamp: new Date()
      }
      this.searchHistory.unshift(history)
      if (this.searchHistory.length > 100) {
        this.searchHistory = this.searchHistory.slice(0, 100)
      }
    },

    updateSearchOptions(options: Partial<SearchOptions>) {
      this.searchOptions = { ...this.searchOptions, ...options }
    }
  }
})
```

### 10.3 后端代码架构

#### 10.3.1 FastAPI 应用架构
```python
# main.py - FastAPI 应用入口
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from app.api import search, index, config, system
from app.core.database import engine, Base

# 创建 FastAPI 应用
app = FastAPI(
    title="小遥搜索 API",
    description="多模态AI智能搜索桌面应用后端",
    version="1.0.0",
    docs_url="/docs",
    redoc_url="/redoc"
)

# CORS 中间件
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# 注册路由
app.include_router(search.router, prefix="/api/search", tags=["搜索"])
app.include_router(index.router, prefix="/api/index", tags=["索引"])
app.include_router(config.router, prefix="/api/config", tags=["配置"])
app.include_router(system.router, prefix="/api/system", tags=["系统"])

@app.on_event("startup")
async def startup_event():
    """应用启动时初始化数据库"""
    Base.metadata.create_all(bind=engine)

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="127.0.0.1", port=8000, reload=True)
```

#### 10.3.2 服务层架构
```python
# services/search_service.py - 搜索业务逻辑
from typing import List, Optional
from app.core.search.hybrid_search import HybridSearchEngine
from app.core.ai_models.llm_service import LLMService
from app.models.search_history import SearchHistory
from app.schemas.search import SearchRequest, SearchResult

class SearchService:
    def __init__(self):
        self.search_engine = HybridSearchEngine()
        self.llm_service = LLMService()

    async def search(self, request: SearchRequest) -> List[SearchResult]:
        """执行搜索请求"""
        try:
            # 1. LLM 查询增强
            enhanced_query = await self.llm_service.enhance_query(request.query)

            # 2. 执行混合搜索
            results = await self.search_engine.search(
                query=enhanced_query,
                search_type=request.search_type,
                limit=request.limit,
                threshold=request.threshold,
                file_types=request.file_types
            )

            # 3. 保存搜索历史
            await self._save_search_history(request, len(results))

            return results

        except Exception as e:
            logger.error(f"搜索失败: {str(e)}")
            raise SearchError(f"搜索失败: {str(e)}")

    async def _save_search_history(self, request: SearchRequest, result_count: int):
        """保存搜索历史"""
        history = SearchHistory(
            search_query=request.query,
            input_type=request.input_type,
            search_type=request.search_type,
            result_count=result_count
        )
        # 保存到数据库
        await history.save()
```

#### 10.3.3 AI 模型服务架构
```python
# core/ai_models/embedding_service.py - 文本嵌入服务
from sentence_transformers import SentenceTransformer
import numpy as np
from typing import List

class EmbeddingService:
    def __init__(self, model_name: str = "BAAI/bge-m3"):
        self.model = None
        self.model_name = model_name
        self.embedding_dim = 1024

    async def load_model(self):
        """延迟加载模型"""
        if self.model is None:
            self.model = SentenceTransformer(self.model_name)
            logger.info(f"BGE-M3 模型加载完成")

    async def encode(self, texts: List[str]) -> np.ndarray:
        """批量文本向量化"""
        await self.load_model()

        # BGE-M3 推荐的预处理
        processed_texts = [self._preprocess_text(text) for text in texts]

        # 批量编码
        embeddings = self.model.encode(
            processed_texts,
            normalize_embeddings=True,
            batch_size=32,
            show_progress_bar=False
        )

        return embeddings

    def _preprocess_text(self, text: str) -> str:
        """BGE-M3 文本预处理"""
        # 移除多余空格和特殊字符
        text = ' '.join(text.split())
        return text.strip()

# core/ai_models/llm_service.py - 大语言模型服务
import ollama
from typing import Optional

class LLMService:
    def __init__(self, model_name: str = "qwen2.5:1.5b"):
        self.model_name = model_name
        self.client = None

    async def initialize(self):
        """初始化 Ollama 客户端"""
        try:
            # 检查 Ollama 服务是否可用
            response = ollama.list()
            if self.model_name not in [model['name'] for model in response['models']]:
                logger.info(f"下载模型 {self.model_name}")
                ollama.pull(self.model_name)
            logger.info(f"LLM 服务初始化完成: {self.model_name}")
        except Exception as e:
            logger.error(f"LLM 服务初始化失败: {str(e)}")

    async def enhance_query(self, query: str) -> str:
        """使用 LLM 增强搜索查询"""
        try:
            prompt = f"""
            请将以下搜索查询改写为更精确的搜索关键词：
            原始查询：{query}

            要求：
            1. 保留原始意图
            2. 提取关键概念
            3. 使用简洁的关键词
            4. 直接输出改写后的查询，不要其他说明
            """

            response = ollama.generate(
                model=self.model_name,
                prompt=prompt
            )

            return response['response'].strip()

        except Exception as e:
            logger.warning(f"LLM 查询增强失败，使用原始查询: {str(e)}")
            return query
```

#### 10.3.4 数据模型架构
```python
# models/base.py - 基础数据模型
from sqlalchemy import Column, Integer, DateTime, func
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import declared_attr

Base = declarative_base()

class TimestampMixin:
    """时间戳混入类"""
    created_at = Column(DateTime, default=func.now(), nullable=False)
    updated_at = Column(DateTime, default=func.now(), onupdate=func.now(), nullable=False)

class BaseModel(Base, TimestampMixin):
    """基础模型类"""
    __abstract__ = True

    id = Column(Integer, primary_key=True, index=True)

    @declared_attr
    def __tablename__(cls):
        return cls.__name__.lower()

# models/file.py - 文件模型
from sqlalchemy import Column, String, Integer, Text, Enum
from sqlalchemy.orm import relationship
from .base import BaseModel
import enum

class FileType(str, enum.Enum):
    DOCUMENT = "document"
    AUDIO = "audio"
    VIDEO = "video"
    IMAGE = "image"

class File(BaseModel):
    """文件索引模型"""
    file_path = Column(String(500), unique=True, nullable=False, index=True)
    file_name = Column(String(255), nullable=False)
    file_extension = Column(String(10), nullable=False)
    file_type = Column(Enum(FileType), nullable=False)
    file_size = Column(Integer, nullable=False)
    content_hash = Column(String(64), nullable=False, index=True)
    faiss_index_id = Column(Integer, index=True)
    whoosh_doc_id = Column(String(64), index=True)

    # 关系
    search_histories = relationship("SearchHistory", back_populates="file")
```

### 10.4 依赖注入和服务配置
```python
# deps.py - FastAPI 依赖注入
from fastapi import Depends
from sqlalchemy.orm import Session
from app.core.database import get_db
from app.services.search_service import SearchService
from app.services.index_service import IndexService

# 数据库依赖
def get_database() -> Session:
    return next(get_db())

# 服务依赖
def get_search_service() -> SearchService:
    return SearchService()

def get_index_service() -> IndexService:
    return IndexService()

# API 路由中使用依赖注入
@router.post("/search")
async def search_files(
    request: SearchRequest,
    db: Session = Depends(get_database),
    search_service: SearchService = Depends(get_search_service)
):
    """搜索文件接口"""
    results = await search_service.search(request)
    return {"success": True, "data": {"results": results}}
```

### 10.5 错误处理和日志架构
```python
# utils/exceptions.py - 自定义异常
class SearchError(Exception):
    """搜索相关错误"""
    pass

class IndexError(Exception):
    """索引相关错误"""
    pass

class AIModelError(Exception):
    """AI模型相关错误"""
    pass

# utils/logger.py - 日志配置
import logging
from logging.handlers import RotatingFileHandler
import os

def setup_logger(name: str, log_file: str, level=logging.INFO):
    """配置日志记录器"""
    formatter = logging.Formatter(
        '%(asctime)s %(name)s %(levelname)s %(message)s'
    )

    handler = RotatingFileHandler(
        log_file, maxBytes=10*1024*1024, backupCount=5
    )
    handler.setFormatter(formatter)

    logger = logging.getLogger(name)
    logger.setLevel(level)
    logger.addHandler(handler)

    return logger

# 全局异常处理器
@app.exception_handler(SearchError)
async def search_error_handler(request, exc):
    """搜索错误全局处理"""
    logger.error(f"搜索错误: {str(exc)}")
    return JSONResponse(
        status_code=500,
        content={"success": False, "message": f"搜索失败: {str(exc)}"}
    )
```

## 11. 未来技术演进规划

### 10.1 短期优化（1-3个月）
- **性能提升**：
  - AI模型量化和优化
  - 搜索算法优化
  - 内存使用优化
- **功能增强**：
  - 更多文件格式支持
  - 高级搜索语法
  - 搜索结果聚合

### 10.2 中期规划（3-6个月）
- **AI能力扩展**：
  - 多模态理解增强
  - 本地RAG实现
  - 知识图谱集成
- **用户体验优化**：
  - 智能推荐
  - 个性化搜索
  - 协作功能

### 10.3 长期愿景（6-12个月）
- **技术升级**：
  - 新AI模型集成
  - 分布式搜索支持
  - 云端同步功能
- **生态建设**：
  - 插件系统
  - API开放平台
  - 第三方集成

---

**文档版本**：v1.0
**最后更新**：2025年12月16日
**维护者**：AI助手

**技术选型原则**：
1. **本地优先**：保护用户隐私，减少网络依赖
2. **开源为主**：降低成本，避免供应商锁定
3. **性能导向**：确保响应速度和用户体验
4. **跨平台兼容**：支持主流操作系统
5. **可扩展性**：为未来功能扩展预留空间